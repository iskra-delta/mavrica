ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 1.
Hexadecimal [24-Bits]



                                      1 		;; bdos.s
                                      2         ;; 
                                      3         ;; minimal bdos wrapper
                                      4 		;;
                                      5         ;; MIT License (see: LICENSE)
                                      6         ;; copyright (c) 2022 tomaz stih
                                      7         ;;
                                      8 		;; 22.03.2022    tstih
                                      9         .module bdos
                                     10 
                                     11         .globl _bdos
                                     12         .globl _bdosret
                                     13 
                           000005    14         .equ    BDOS, 5
                                     15 
                                     16         .area _CODE
                                     17 
                                     18 
                                     19         ;; ---------------------------------------------------------
                                     20         ;; unsigned char bdos(unsigned char fn, unsigned int param);
                                     21         ;; ---------------------------------------------------------
                                     22         ;; calls cp/m bdos
                                     23         ;; affect:  af, bc, de, hl
      000000                         24 _bdos::
      000000 DD E5            [15]   25         push    ix                      ; store ix
      000002 CD 21 00         [17]   26 		call    rawbdos                 ; raw bdos fn call
      000005 DD E1            [14]   27 		pop     ix                      ; restore ix
      000007 6F               [ 4]   28         ld      l,a                     ; return a
      000008 C9               [10]   29 		ret
                                     30 
                                     31 
                                     32         ;; -------------------------------------------------------------------------
                                     33         ;; bdos_ret_t *bdosret(unsigned char fn, unsigned int param, bdos_ret_t *p);
                                     34         ;; -------------------------------------------------------------------------
                                     35         ;; calls cp/m bdos and store result to variables
                                     36         ;; output: a, b, hl populated with ret. values
                                     37         ;; affect:  af, bc, de, hl
      000009                         38 _bdosret::
                                     39         ;; classic bdos call!
      000009 DD E5            [15]   40         push    ix
      00000B CD 21 00         [17]   41         call    rawbdos
                                     42 		;; store ret value to de.
      00000E EB               [ 4]   43 		ex      de, hl      
                                     44         ;; get bdos_ret_t *p to hl
      00000F DD 6E 03         [19]   45 		ld      l,3(ix)
      000012 DD 66 04         [19]   46 		ld      h,4(ix) 
      000015 E5               [11]   47         push    hl                      ; store pointer as return value
      000016 77               [ 7]   48         ld      (hl),a                  ; store a
      000017 23               [ 6]   49         inc     hl
      000018 70               [ 7]   50         ld      (hl),b                  ; store b
      000019 23               [ 6]   51         inc     hl
      00001A 73               [ 7]   52         ld      (hl),e                  ; and hl
      00001B 23               [ 6]   53         inc     hl
      00001C 72               [ 7]   54         ld      (hl),d
                                     55         ;; restore return value
ASxxxx Assembler V02.00 + NoICE + SDCC mods  (Zilog Z80 / Hitachi HD64180 / ZX-Next / eZ80), page 2.
Hexadecimal [24-Bits]



      00001D E1               [10]   56         pop     hl
                                     57         ;; clean stack and exit
      00001E DD E1            [14]   58 		pop     ix                      ; restore ix
      000020 C9               [10]   59 		ret
                                     60 
                                     61 
                                     62         ;; raw bdos call
                                     63         ;; input:	bdos_call_t struct pointer on stack
                                     64         ;; output:  ix=stack, (a,b,de)=potential result
                                     65         ;; affect:  af, bc, de, hl, ix
      000021                         66 rawbdos:
      000021 DD 21 06 00      [14]   67         ld      ix,#6
      000025 DD 39            [15]   68 		add     ix,sp                   ; ix=sp
      000027 DD 4E 00         [19]   69 		ld      c,(ix)                  ; bdos function into c.
      00002A DD 5E 01         [19]   70 		ld      e,1(ix)                 ; load bdos parameter into de
      00002D DD 56 02         [19]   71 		ld      d,2(ix)
      000030 CD 05 00         [17]   72 		call    BDOS                    ; make BDOS call!
      000033 C9               [10]   73         ret
